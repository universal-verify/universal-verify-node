import e,{createHmac as t}from"node:crypto";import r from"jwks-rsa";import n from"jsonwebtoken";const i="https://api.universalverify.com";class ApiClient{constructor(){}async exchangeCodeForTokens(e){const t=await fetch(i+"/token",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!t.ok)throw new Error(`Token exchange failed: ${t.statusText}`);return t.json()}async getUserInfo(e,t){let r=i+"/userinfo";t&&(r+=`?timezone=${t}`);const n=await fetch(r,{headers:{Authorization:`Bearer ${e}`}});if(!n.ok)throw new Error(`Failed to get user info: ${n.statusText}`);return n.json()}async getRegionalUserInfo(e,t){const r=await fetch(t,{headers:{Authorization:`Bearer ${e}`}});if(!r.ok)throw new Error(`Failed to get regional user info: ${r.statusText}`);return r.json()}async revokeToken(e,t,r){const n=await fetch(i+"/revoke",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({token:e,client_id:t,client_secret:r})});if(!n.ok)throw new Error(`Token revocation failed: ${n.statusText}`);return n.json()}async refreshToken(e){const t=await fetch(i+"/token",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!t.ok)throw new Error(`Token refresh failed: ${t.statusText}`);return t.json()}}const o=r({jwksUri:"https://api.universalverify.com/.well-known/jwks.json",requestHeaders:{},timeout:3e4});class UniversalVerify{constructor(e,t){if(!e||"string"!=typeof e)throw new Error("clientId is required");if(!t||"string"!=typeof t)throw new Error("clientSecret is required");this.clientId=e,this.clientSecret=t,this.api=new ApiClient(e,t)}createCodeChallenge(t){t||(t=e.randomBytes(32).toString("base64url"));return{codeVerifier:t,codeChallenge:e.createHash("sha256").update(t).digest("base64url")}}async exchangeCodeForTokens(e){return function(e,t){for(const r of t)if(!e[r.name]||typeof e[r.name]!==r.type)throw new Error(`${r.name} is required`)}(e,[{name:"code",type:"string"},{name:"codeVerifier",type:"string"},{name:"redirectUri",type:"string"}]),await this.api.exchangeCodeForTokens({client_id:this.clientId,client_secret:this.clientSecret,grant_type:"authorization_code",code:e.code,code_verifier:e.codeVerifier,redirect_uri:e.redirectUri})}async getUserInfo(e,t){return await this.api.getUserInfo(e,t)}async getRegionalUserInfo(e,t){return await this.api.getRegionalUserInfo(e,t)}verifyWebhookSignature(e,r,n){let i=function(e,r,n){const i=t("sha256",n);return i.update(e),i.digest("hex")===r}(e,r,n);if(!i)throw new Error("Invalid webhook signature");return JSON.parse(e)}async revokeToken(e){return await this.api.revokeToken(e,this.clientId,this.clientSecret)}async validateIdToken(e,t){return async function(e,t,r){const{header:s}=n.decode(e,{complete:!0})||{};if(!s||!s.kid)throw new Error("Invalid token header");const a=(await o.getSigningKey(s.kid)).getPublicKey(),c=n.verify(e,a,{algorithms:["RS256"],audience:t,issuer:i});if(r&&c.nonce!==r)throw new Error("Invalid nonce");return c}(e,this.clientId,t)}async refreshToken(e){return await this.api.refreshToken({refresh_token:e,client_id:this.clientId,client_secret:this.clientSecret,grant_type:"refresh_token"})}static get version(){return"0.0.2"}}export{UniversalVerify as default};
